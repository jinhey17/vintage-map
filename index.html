<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¹ˆí‹°ì§€ ë³´ë¬¼ì§€ë„</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ddb2d2fdd091b40e8df161e74dbc3aeb"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
      height: 100%; 
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
    }
    
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 0 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 200;
    }
    
    #map { 
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    
    .my-location-btn {
      position: fixed;
      bottom: 90px;
      right: 16px;
      width: 44px;
      height: 44px;
      background: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      font-size: 20px;
      z-index: 150;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .my-location-btn:hover {
      background: #f3f4f6;
    }
    .my-location-btn.loading {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      z-index: 100;
      transition: transform 0.3s ease-out;
      height: 75vh;
      max-height: calc(100vh - 56px);
    }
    .bottom-sheet.closed { 
      transform: translateY(calc(100% - 64px)); 
    }
    .bottom-sheet.open { 
      transform: translateY(0); 
    }
    
    .handle-area {
      padding: 12px 16px 8px;
      cursor: pointer;
      background: white;
      border-radius: 16px 16px 0 0;
    }
    
    .handle {
      width: 36px;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
      margin: 0 auto 8px;
    }
    
    .sheet-title {
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      color: #374151;
    }
    
    .store-list {
      overflow-y: auto;
      height: calc(75vh - 56px);
      padding-bottom: 100px;
      -webkit-overflow-scrolling: touch;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 14px;
      margin: 8px 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      border: 1px solid #f3f4f6;
    }
    .card:active { 
      background: #f9fafb; 
      transform: scale(0.99);
    }
    
    .filter-chip {
      display: inline-flex;
      align-items: center;
      padding: 8px 14px;
      border-radius: 20px;
      border: 2px solid #e5e7eb;
      background: white;
      cursor: pointer;
      margin: 4px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .filter-chip:hover { border-color: #3b82f6; }
    .filter-chip.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: flex-end;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      width: 100%;
      border-radius: 16px 16px 0 0;
      max-height: 85vh;
      overflow-y: auto;
    }
    
    .detail-page {
      position: fixed;
      inset: 0;
      background: white;
      z-index: 2000;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .photo-slide {
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 56px;
    }
    
    .detail-map {
      width: 100%;
      height: 160px;
      border-radius: 12px;
      margin: 12px 0;
    }
    
    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      margin: 2px;
    }
    .tag-gray { background: #f3f4f6; color: #374151; }
    .tag-green { background: #dcfce7; color: #166534; }
    .tag-blue { background: #dbeafe; color: #1e40af; }
    
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin: 16px 0;
    }
    .btn-group button {
      padding: 12px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-group button:active { background: #f9fafb; }
    
    .loading-container {
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
      color: #6b7280;
      font-size: 15px;
    }
    
    .info-window {
      padding: 12px 14px;
      min-width: 180px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    }
    .info-window h4 {
      margin: 0 0 6px 0;
      font-size: 14px;
      font-weight: bold;
      color: #111;
    }
    .info-window p {
      margin: 0 0 10px 0;
      font-size: 12px;
      color: #666;
    }
    .info-window button {
      width: 100%;
      padding: 8px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="map"></div>

  <script>
    window.kakaoMap = null;
    window.markers = [];
    window.currentOverlay = null;
    window.myLocationMarker = null;
    
    window.initMap = function() {
      if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
        document.getElementById('map').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#fee2e2;color:#dc2626;">ì¹´ì¹´ì˜¤ë§µ ë¡œë”© ì‹¤íŒ¨</div>';
        return;
      }
      
      var container = document.getElementById('map');
      var options = {
        center: new kakao.maps.LatLng(37.5400, 126.9700),
        level: 7
      };
      var map = new kakao.maps.Map(container, options);
      window.kakaoMap = map;
      
      var zoomControl = new kakao.maps.ZoomControl();
      map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
      
      kakao.maps.event.addListener(map, 'click', function() {
        if (window.currentOverlay) {
          window.currentOverlay.setMap(null);
          window.currentOverlay = null;
        }
      });
    };
    
    window.updateMarkers = function(stores) {
      window.markers.forEach(function(item) {
        item.marker.setMap(null);
        if (item.overlay) item.overlay.setMap(null);
      });
      window.markers = [];
      
      if (!window.kakaoMap) return;
      
      stores.forEach(function(store) {
        var marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(store.lat, store.lng),
          map: window.kakaoMap
        });
        
        var content = document.createElement('div');
        content.className = 'info-window';
        content.innerHTML = 
          '<h4>' + store.name + '</h4>' +
          '<p>' + store.address + '</p>' +
          '<button onclick="window.openStoreDetail(' + store.id + ')">ìƒì„¸ë³´ê¸°</button>';
        
        var overlay = new kakao.maps.CustomOverlay({
          content: content,
          position: new kakao.maps.LatLng(store.lat, store.lng),
          yAnchor: 1.5
        });
        
        kakao.maps.event.addListener(marker, 'click', function() {
          if (window.currentOverlay) {
            window.currentOverlay.setMap(null);
          }
          overlay.setMap(window.kakaoMap);
          window.currentOverlay = overlay;
        });
        
        window.markers.push({ marker: marker, overlay: overlay, store: store });
      });
    };
    
    window.openStoreDetail = function(storeId) {
      if (window.currentOverlay) {
        window.currentOverlay.setMap(null);
        window.currentOverlay = null;
      }
      if (window.setSelectedStoreById) {
        window.setSelectedStoreById(storeId);
      }
    };
    
    window.goToMyLocation = function(callback) {
      if (!navigator.geolocation) {
        alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        if (callback) callback(false);
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          var locPosition = new kakao.maps.LatLng(lat, lng);
          
          window.kakaoMap.setCenter(locPosition);
          window.kakaoMap.setLevel(4);
          
          if (window.myLocationMarker) {
            window.myLocationMarker.setMap(null);
          }
          
          var markerContent = '<div style="width:18px;height:18px;background:#3b82f6;border:3px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>';
          
          window.myLocationMarker = new kakao.maps.CustomOverlay({
            position: locPosition,
            content: markerContent,
            yAnchor: 0.5,
            xAnchor: 0.5
          });
          window.myLocationMarker.setMap(window.kakaoMap);
          
          if (callback) callback(true);
        },
        function(error) {
          var message = 'ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          if (error.code === 1) {
            message = 'ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
          }
          alert(message);
          if (callback) callback(false);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 300000
        }
      );
    };
    
    window.onload = function() {
      window.initMap();
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSWUKKJrrtiQvRAldU0h9od8TX4Ms0c-VU5-fkWnQ8aVwFwSm_fZNWUNY1gLR6T4K1cj2HO5JtI-Lsg/pub?output=csv';

    // ë”°ì˜´í‘œ ì œê±° í•¨ìˆ˜
    function cleanValue(val) {
      if (!val) return '';
      return val.trim().replace(/^["']|["']$/g, '').replace(/"/g, '');
    }

    function parseCSV(csv) {
      const lines = csv.split('\n');
      const stores = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const values = line.split(',');
        if (values.length < 10) continue;
        
        const store = {
          id: parseInt(values[0]) || i,
          name: cleanValue(values[1]),
          address: cleanValue(values[2]),
          lat: parseFloat(values[3]) || 0,
          lng: parseFloat(values[4]) || 0,
          phone: cleanValue(values[5]),
          hours: cleanValue(values[6]),
          storeType: cleanValue(values[7]),
          disposal: cleanValue(values[8]),
          styles: cleanValue(values[9]),
          gender: cleanValue(values[10]),
          fitting: cleanValue(values[11]).toUpperCase() === 'TRUE',
          restroom: cleanValue(values[12]).toUpperCase() === 'TRUE',
          parking: cleanValue(values[13]).toUpperCase() === 'TRUE',
        };
        
        if (store.name && store.lat && store.lng) {
          stores.push(store);
        }
      }
      
      return stores;
    }

    const storeTypeLabels = {
      'ëª…í’ˆ': { emoji: 'ğŸ’', label: 'ëª…í’ˆ' },
      'ì…€ë ‰íŠ¸ìƒµ': { emoji: 'ğŸ§¢', label: 'ì…€ë ‰íŠ¸ìƒµ' },
      'í‚¬ë¡œìƒµ': { emoji: 'âš–ï¸', label: 'í‚¬ë¡œìƒµ' },
      'ì‚¬íšŒì ê¸°ì—…': { emoji: 'ğŸ€', label: 'ì‚¬íšŒì ê¸°ì—…' }
    };

    const disposalLabels = {
      'íŒë§¤ê°€ëŠ¥': { emoji: 'ğŸ’°', label: 'íŒë§¤ê°€ëŠ¥' },
      'ê¸°ë¶€ê°€ëŠ¥': { emoji: 'ğŸ', label: 'ê¸°ë¶€ê°€ëŠ¥' },
      'ë¶ˆê°€': { emoji: 'âŒ', label: 'ë¶ˆê°€' }
    };

    const styleLabels = {
      'ì•„ë©”ì¹´ì§€': { emoji: 'ğŸ‡ºğŸ‡¸', label: 'ì•„ë©”ì¹´ì§€' },
      'ì¼ë³¸í˜ë¯¸ë‹Œ': { emoji: 'ğŸ‘—', label: 'ì¼ë³¸í˜ë¯¸ë‹Œ' },
      'ìŠ¤íŠ¸ë¦¿': { emoji: 'ğŸ›¹', label: 'ìŠ¤íŠ¸ë¦¿' },
      'í´ë˜ì‹': { emoji: 'ğŸ‘”', label: 'í´ë˜ì‹' },
      'ê¸°íƒ€': { emoji: 'âœ¨', label: 'ê¸°íƒ€' }
    };

    const genderLabels = {
      'ë‚¨ë…€ê³µìš©': { emoji: 'ğŸ‘«', label: 'ë‚¨ë…€ê³µìš©' },
      'ì—¬ì„±ì „ìš©': { emoji: 'ğŸ‘©', label: 'ì—¬ì„±ì „ìš©' },
      'ë‚¨ì„±ì „ìš©': { emoji: 'ğŸ‘¨', label: 'ë‚¨ì„±ì „ìš©' }
    };

    function FilterModal({ isOpen, onClose, filters, setFilters }) {
      if (!isOpen) return null;

      const toggleFilter = (category, value) => {
        setFilters(prev => {
          const current = prev[category] || [];
          if (current.includes(value)) {
            return { ...prev, [category]: current.filter(v => v !== value) };
          } else {
            return { ...prev, [category]: [...current, value] };
          }
        });
      };

      const activeCount = Object.values(filters).flat().length;

      return (
        <div className="modal" onClick={onClose}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div style={{ position: 'sticky', top: 0, background: 'white', borderBottom: '1px solid #e5e7eb', padding: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', zIndex: 10 }}>
              <button onClick={onClose} style={{ fontSize: '22px', border: 'none', background: 'none', cursor: 'pointer' }}>â†</button>
              <h2 style={{ fontWeight: 'bold', fontSize: '17px', margin: 0 }}>í•„í„°</h2>
              <button onClick={() => setFilters({})} style={{ color: '#3b82f6', border: 'none', background: 'none', cursor: 'pointer', fontSize: '14px' }}>ì´ˆê¸°í™”</button>
            </div>

            <div style={{ padding: '16px' }}>
              <h3 style={{ fontWeight: 'bold', marginBottom: '12px', fontSize: '15px' }}>ğŸ›ï¸ ë§¤ì¥ ìœ í˜•</h3>
              <div style={{ display: 'flex', flexWrap: 'wrap', marginBottom: '20px' }}>
                {Object.entries(storeTypeLabels).map(([key, { emoji, label }]) => (
                  <div key={key} className={`filter-chip ${filters.storeType?.includes(key) ? 'active' : ''}`} onClick={() => toggleFilter('storeType', key)}>
                    <span style={{ marginRight: '6px' }}>{emoji}</span>{label}
                  </div>
                ))}
              </div>

              <h3 style={{ fontWeight: 'bold', marginBottom: '12px', fontSize: '15px' }}>â™»ï¸ ì˜· ì²˜ë¶„</h3>
              <div style={{ display: 'flex', flexWrap: 'wrap', marginBottom: '20px' }}>
                {Object.entries(disposalLabels).map(([key, { emoji, label }]) => (
                  <div key={key} className={`filter-chip ${filters.disposal?.includes(key) ? 'active' : ''}`} onClick={() => toggleFilter('disposal', key)}>
                    <span style={{ marginRight: '6px' }}>{emoji}</span>{label}
                  </div>
                ))}
              </div>

              <h3 style={{ fontWeight: 'bold', marginBottom: '12px', fontSize: '15px' }}>ğŸ’¡ ìŠ¤íƒ€ì¼</h3>
              <div style={{ display: 'flex', flexWrap: 'wrap', marginBottom: '20px' }}>
                {Object.entries(styleLabels).map(([key, { emoji, label }]) => (
                  <div key={key} className={`filter-chip ${filters.styles?.includes(key) ? 'active' : ''}`} onClick={() => toggleFilter('styles', key)}>
                    <span style={{ marginRight: '6px' }}>{emoji}</span>{label}
                  </div>
                ))}
              </div>

              <h3 style={{ fontWeight: 'bold', marginBottom: '12px', fontSize: '15px' }}>ğŸ‘¥ ì„±ë³„</h3>
              <div style={{ display: 'flex', flexWrap: 'wrap', marginBottom: '20px' }}>
                {Object.entries(genderLabels).map(([key, { emoji, label }]) => (
                  <div key={key} className={`filter-chip ${filters.gender?.includes(key) ? 'active' : ''}`} onClick={() => toggleFilter('gender', key)}>
                    <span style={{ marginRight: '6px' }}>{emoji}</span>{label}
                  </div>
                ))}
              </div>

              <h3 style={{ fontWeight: 'bold', marginBottom: '12px', fontSize: '15px' }}>ğŸ¢ í¸ì˜ì‹œì„¤</h3>
              <div style={{ display: 'flex', flexWrap: 'wrap', marginBottom: '20px' }}>
                {[
                  { value: 'fitting', label: 'ğŸ‘• í”¼íŒ…ë£¸' },
                  { value: 'restroom', label: 'ğŸš» í™”ì¥ì‹¤' },
                  { value: 'parking', label: 'ğŸ…¿ï¸ ì£¼ì°¨ê°€ëŠ¥' }
                ].map(({ value, label }) => (
                  <div key={value} className={`filter-chip ${filters.amenities?.includes(value) ? 'active' : ''}`} onClick={() => toggleFilter('amenities', value)}>
                    {label}
                  </div>
                ))}
              </div>
            </div>

            <div style={{ position: 'sticky', bottom: 0, background: 'white', borderTop: '1px solid #e5e7eb', padding: '16px' }}>
              <button onClick={onClose} style={{ width: '100%', background: '#3b82f6', color: 'white', padding: '14px', borderRadius: '10px', fontWeight: 'bold', border: 'none', cursor: 'pointer', fontSize: '15px' }}>
                ì ìš©í•˜ê¸° {activeCount > 0 && `(${activeCount})`}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function DetailPage({ store, onClose }) {
      const mapRef = useRef(null);
      
      useEffect(() => {
        if (!store || !mapRef.current || typeof kakao === 'undefined') return;
        
        const position = new kakao.maps.LatLng(store.lat, store.lng);
        const map = new kakao.maps.Map(mapRef.current, {
          center: position,
          level: 3
        });
        
        new kakao.maps.Marker({
          position: position,
          map: map
        });
      }, [store]);

      if (!store) return null;

      const storeTypeInfo = storeTypeLabels[store.storeType] || { emoji: 'ğŸª', label: store.storeType };
      const disposalInfo = disposalLabels[store.disposal] || { emoji: 'ğŸ“¦', label: store.disposal };
      const styleInfo = styleLabels[store.styles] || { emoji: 'âœ¨', label: store.styles };
      const genderInfo = genderLabels[store.gender] || { emoji: 'ğŸ‘¥', label: store.gender };

      return (
        <div className="detail-page">
          <div style={{ position: 'sticky', top: 0, background: 'white', borderBottom: '1px solid #e5e7eb', padding: '14px 16px', display: 'flex', alignItems: 'center', zIndex: 10 }}>
            <button onClick={onClose} style={{ fontSize: '22px', marginRight: '12px', border: 'none', background: 'none', cursor: 'pointer' }}>â†</button>
            <h1 style={{ fontWeight: 'bold', fontSize: '17px', margin: 0 }}>{store.name}</h1>
          </div>

          <div className="photo-slide">ğŸª</div>

          <div style={{ padding: '20px 16px' }}>
            <h2 style={{ fontSize: '22px', fontWeight: 'bold', marginBottom: '16px' }}>{store.name}</h2>

            <div style={{ marginBottom: '20px', lineHeight: '1.8', fontSize: '14px' }}>
              <p style={{ margin: '6px 0' }}>ğŸ“ {store.address}</p>
              <p style={{ margin: '6px 0' }}>ğŸ• {store.hours}</p>
              <p style={{ margin: '6px 0' }}>ğŸ“ {store.phone}</p>
            </div>

            <hr style={{ border: 'none', borderTop: '1px solid #e5e7eb', margin: '20px 0' }} />

            <h3 style={{ fontWeight: 'bold', marginBottom: '10px', fontSize: '15px' }}>ğŸ›ï¸ ë§¤ì¥ ìœ í˜•</h3>
            <div style={{ marginBottom: '20px' }}>
              <span className="tag tag-gray">{storeTypeInfo.emoji} {storeTypeInfo.label}</span>
            </div>

            <h3 style={{ fontWeight: 'bold', marginBottom: '10px', fontSize: '15px' }}>â™»ï¸ ì˜· ì²˜ë¶„</h3>
            <div style={{ marginBottom: '20px' }}>
              <span className="tag tag-green">{disposalInfo.emoji} {disposalInfo.label}</span>
            </div>

            <h3 style={{ fontWeight: 'bold', marginBottom: '10px', fontSize: '15px' }}>ğŸ’¡ ìŠ¤íƒ€ì¼</h3>
            <div style={{ marginBottom: '20px' }}>
              <span className="tag tag-blue">{styleInfo.emoji} {styleInfo.label}</span>
            </div>

            <h3 style={{ fontWeight: 'bold', marginBottom: '10px', fontSize: '15px' }}>ğŸ‘¥ ì„±ë³„</h3>
            <div style={{ marginBottom: '20px' }}>
              <span className="tag tag-gray">{genderInfo.emoji} {genderInfo.label}</span>
            </div>

            <h3 style={{ fontWeight: 'bold', marginBottom: '10px', fontSize: '15px' }}>ğŸ¢ í¸ì˜ì‹œì„¤</h3>
            <div style={{ display: 'flex', gap: '12px', marginBottom: '20px', flexWrap: 'wrap', fontSize: '14px' }}>
              <span>{store.fitting ? 'âœ…' : 'âŒ'} í”¼íŒ…ë£¸</span>
              <span>{store.restroom ? 'âœ…' : 'âŒ'} í™”ì¥ì‹¤</span>
              <span>{store.parking ? 'âœ…' : 'âŒ'} ì£¼ì°¨</span>
            </div>

            <hr style={{ border: 'none', borderTop: '1px solid #e5e7eb', margin: '20px 0' }} />

            <h3 style={{ fontWeight: 'bold', marginBottom: '10px', fontSize: '15px' }}>ğŸ“ ìœ„ì¹˜</h3>
            <div ref={mapRef} className="detail-map"></div>

            <div className="btn-group">
              <button onClick={() => window.open(`https://map.kakao.com/link/to/${store.name},${store.lat},${store.lng}`)}>
                ğŸ“ ê¸¸ì°¾ê¸°
              </button>
              <button onClick={() => window.location.href = `tel:${store.phone}`}>
                ğŸ“ ì „í™”
              </button>
              <button onClick={() => {
                if (navigator.share) {
                  navigator.share({ title: store.name, text: store.address, url: window.location.href });
                } else {
                  alert('ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                }
              }}>
                ğŸ”— ê³µìœ 
              </button>
            </div>
            
            <div style={{ height: '50px' }}></div>
          </div>
        </div>
      );
    }

    function App() {
      const [stores, setStores] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [isBottomSheetOpen, setIsBottomSheetOpen] = useState(false);
      const [isFilterOpen, setIsFilterOpen] = useState(false);
      const [filters, setFilters] = useState({});
      const [selectedStore, setSelectedStore] = useState(null);
      const [locating, setLocating] = useState(false);

      useEffect(() => {
        fetch(SHEET_URL)
          .then(response => response.text())
          .then(csv => {
            const parsedStores = parseCSV(csv);
            setStores(parsedStores);
            setLoading(false);
            
            if (window.updateMarkers) {
              window.updateMarkers(parsedStores);
            }
          })
          .catch(err => {
            console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', err);
            setError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            setLoading(false);
          });
      }, []);

      useEffect(() => {
        window.setSelectedStoreById = (id) => {
          const store = stores.find(s => s.id === id);
          if (store) {
            setSelectedStore(store);
          }
        };
      }, [stores]);

      const filteredStores = stores.filter(store => {
        if (filters.storeType?.length && !filters.storeType.includes(store.storeType)) return false;
        if (filters.disposal?.length && !filters.disposal.includes(store.disposal)) return false;
        if (filters.styles?.length && !filters.styles.includes(store.styles)) return false;
        if (filters.gender?.length && !filters.gender.includes(store.gender)) return false;
        if (filters.amenities?.length) {
          if (filters.amenities.includes('fitting') && !store.fitting) return false;
          if (filters.amenities.includes('restroom') && !store.restroom) return false;
          if (filters.amenities.includes('parking') && !store.parking) return false;
        }
        return true;
      });

      useEffect(() => {
        if (window.updateMarkers) {
          window.updateMarkers(filteredStores);
        }
      }, [filteredStores]);

      const activeFilterCount = Object.values(filters).flat().length;

      const handleReset = () => {
        setIsBottomSheetOpen(false);
        setFilters({});
        setSelectedStore(null);
      };

      const handleMyLocation = () => {
        setLocating(true);
        window.goToMyLocation(function(success) {
          setLocating(false);
        });
      };

      if (loading) {
        return (
          <>
            <div className="header">
              <h1 style={{ fontSize: '18px', fontWeight: 'bold', margin: 0 }}>ğŸ—ºï¸ ë¹ˆí‹°ì§€ ë³´ë¬¼ì§€ë„</h1>
            </div>
            <div className="loading-container">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </>
        );
      }

      if (error) {
        return (
          <>
            <div className="header">
              <h1 style={{ fontSize: '18px', fontWeight: 'bold', margin: 0 }}>ğŸ—ºï¸ ë¹ˆí‹°ì§€ ë³´ë¬¼ì§€ë„</h1>
            </div>
            <div className="loading-container" style={{ color: '#dc2626' }}>{error}</div>
          </>
        );
      }

      return (
        <>
          <div className="header">
            <h1 style={{ fontSize: '18px', fontWeight: 'bold', cursor: 'pointer', margin: 0 }} onClick={handleReset}>
              ğŸ—ºï¸ ë¹ˆí‹°ì§€ ë³´ë¬¼ì§€ë„
            </h1>
            <button onClick={() => setIsFilterOpen(true)} style={{ position: 'relative', padding: '8px 14px', border: '1px solid #e5e7eb', borderRadius: '8px', background: 'white', cursor: 'pointer', fontSize: '13px' }}>
              ğŸ” í•„í„°
              {activeFilterCount > 0 && (
                <span style={{ position: 'absolute', top: '-6px', right: '-6px', background: '#3b82f6', color: 'white', fontSize: '11px', width: '18px', height: '18px', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                  {activeFilterCount}
                </span>
              )}
            </button>
          </div>

          <button 
            className={`my-location-btn ${locating ? 'loading' : ''}`}
            onClick={handleMyLocation}
            title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™"
          >
            ğŸ“
          </button>

          <div className={`bottom-sheet ${isBottomSheetOpen ? 'open' : 'closed'}`}>
            <div className="handle-area" onClick={() => setIsBottomSheetOpen(!isBottomSheetOpen)}>
              <div className="handle"></div>
              <div className="sheet-title">
                {isBottomSheetOpen ? `ë§¤ì¥ ${filteredStores.length}ê°œ` : `ëª©ë¡ ì—´ê¸° (${filteredStores.length}ê°œ)`}
              </div>
            </div>

            {isBottomSheetOpen && (
              <div className="store-list">
                {filteredStores.map(store => {
                  const storeTypeInfo = storeTypeLabels[store.storeType] || { emoji: 'ğŸª', label: store.storeType };
                  const disposalInfo = disposalLabels[store.disposal] || { emoji: 'ğŸ“¦', label: store.disposal };
                  
                  return (
                    <div key={store.id} className="card" onClick={() => setSelectedStore(store)}>
                      <h3 style={{ fontWeight: 'bold', fontSize: '16px', marginBottom: '6px' }}>ğŸª {store.name}</h3>
                      <p style={{ color: '#4b5563', fontSize: '13px', marginBottom: '10px' }}>ğŸ“ {store.address}</p>
                      <div>
                        <span className="tag tag-gray">{storeTypeInfo.emoji} {storeTypeInfo.label}</span>
                        <span className="tag tag-green">{disposalInfo.emoji} {disposalInfo.label}</span>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          <FilterModal isOpen={isFilterOpen} onClose={() => setIsFilterOpen(false)} filters={filters} setFilters={setFilters} />
          
          {selectedStore && <DetailPage store={selectedStore} onClose={() => setSelectedStore(null)} />}
        </>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
